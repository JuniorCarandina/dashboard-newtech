<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard New Tech - Cloud Edition (CORRIGIDO)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.ativo { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 12px; padding: 20px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; }
        .etapa-concluida { background: #10b981; color: white; }
        .etapa-atual { background: #f59e0b; color: white; }
        .etapa-pendente { background: #e5e7eb; color: #6b7280; }
        .processo-timeline { position: relative; }
        .processo-timeline::before { content: ''; position: absolute; left: 17px; top: 0; bottom: 0; width: 2px; background: #e5e7eb; }
        .etapa-item { position: relative; padding-left: 50px; margin-bottom: 15px; }
        .etapa-numero { position: absolute; left: 0; top: 0; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button { padding: 8px 16px; margin-right: 4px; border-radius: 6px; cursor: pointer; }
        .tab-button.active { background: #3b82f6; color: white; }
        .tab-button:not(.active) { background: #e5e7eb; color: #6b7280; }
        .tab-button:not(.active):hover { background: #d1d5db; }
        .sync-indicator { position: fixed; top: 20px; right: 20px; padding: 8px 16px; border-radius: 6px; font-size: 12px; z-index: 1001; }
        .sync-success { background: #10b981; color: white; }
        .sync-error { background: #ef4444; color: white; }
        .sync-pending { background: #f59e0b; color: white; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        .fade-out { animation: fadeOut 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        
        /* Estilos para importa√ß√£o CSV */
        .csv-upload { border: 2px dashed #3b82f6; border-radius: 8px; padding: 20px; text-align: center; background: #f8fafc; cursor: pointer; transition: all 0.3s ease; }
        .csv-upload:hover { background: #e0f2fe; border-color: #1976d2; }
        .csv-upload.drag-over { background: #bbf7d0; border-color: #059669; }
        .csv-preview-item { background: #f8f9fa; padding: 8px; margin: 4px 0; border-radius: 4px; border-left: 3px solid #3b82f6; }
        .csv-error { border-left-color: #ef4444; background: #fef2f2; }
        .csv-success { border-left-color: #10b981; background: #f0fdf4; }

        /* NOVO: Indicador de corre√ß√µes aplicadas */
        .fix-badge { 
            position: fixed; 
            bottom: 20px; 
            left: 20px; 
            background: linear-gradient(45deg, #10b981, #059669); 
            color: white; 
            padding: 10px 15px; 
            border-radius: 25px; 
            font-size: 12px; 
            font-weight: bold; 
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            z-index: 1002;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- NOVO: Badge de corre√ß√µes aplicadas -->
    <div class="fix-badge">
        ‚úÖ TODAS AS CORRE√á√ïES APLICADAS
    </div>
    
    <!-- Indicador de Sincroniza√ß√£o -->
    <div id="sync-indicator" class="sync-indicator" style="display: none;"></div>
    
    <div class="max-w-[98vw] mx-auto p-4">
        <!-- Header MELHORADO -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">
                        Dashboard New Tech - Cloud Edition 
                        <span class="text-green-600 text-lg">(CORRIGIDO)</span>
                    </h1>
                    <p class="text-gray-600">Sistema integrado de controle de produ√ß√£o com sincroniza√ß√£o autom√°tica</p>
                    <div class="text-sm text-green-600 mt-2">
                        üîß Filtro por respons√°vel CORRIGIDO ‚Ä¢ ‚úÖ Status conclu√≠dos CORRIGIDO ‚Ä¢ ‚è±Ô∏è Sync 10min APLICADO
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-sm text-gray-500">
                        <div>√öltima sync: <span id="ultima-sync">--:--</span></div>
                        <div>Status: <span id="status-conexao" class="font-medium">üü¢ Online</span></div>
                        <div class="text-xs text-blue-600 mt-1">Sync autom√°tico: <span id="sync-interval">10 min</span></div>
                    </div>
                    <button onclick="sincronizarManual()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
                        üîÑ Sincronizar
                    </button>
                </div>
            </div>
        </div>

        <!-- Configura√ß√£o da API -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6" id="config-api" style="display: none;">
            <h3 class="font-semibold text-yellow-800 mb-2">‚öôÔ∏è Configura√ß√£o da API NewTech v25</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-yellow-700 mb-1">URL da API</label>
                    <input type="text" id="api-url" placeholder="http://localhost:8080/api" 
                        class="w-full border border-yellow-300 rounded px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-yellow-700 mb-1">Token de Acesso</label>
                    <input type="password" id="api-token" placeholder="newtech-token-2025" 
                        class="w-full border border-yellow-300 rounded px-3 py-2 text-sm">
                </div>
                <div class="flex items-end">
                    <button onclick="salvarConfigAPI()" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 text-sm">
                        üíæ Salvar Config
                    </button>
                </div>
            </div>
        </div>

        <!-- Estat√≠sticas MELHORADAS -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total de Projetos</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-projetos">0</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">üìä</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Conclu√≠dos</p>
                        <p class="text-2xl font-bold text-green-600" id="projetos-concluidos">0</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">‚úÖ</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Em Andamento</p>
                        <p class="text-2xl font-bold text-yellow-600" id="projetos-andamento">0</p>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-full">‚è≥</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Etapa M√©dia</p>
                        <p class="text-2xl font-bold text-blue-600" id="etapa-media">0.0</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">üìà</div>
                </div>
            </div>
            <!-- NOVO: Estat√≠stica de respons√°veis ativos -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Pessoas Ativas</p>
                        <p class="text-2xl font-bold text-purple-600" id="pessoas-ativas">0</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full">üë•</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Prazo M√©dio</p>
                        <p class="text-2xl font-bold text-indigo-600" id="prazo-medio">0 dias</p>
                    </div>
                    <div class="bg-indigo-100 p-3 rounded-full">üìÖ</div>
                </div>
            </div>
        </div>

        <!-- Controles MELHORADOS -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
            <div class="flex flex-wrap gap-3 items-center justify-between">
                <div class="flex flex-wrap items-center gap-3">
                    <select id="filtro-etapa" onchange="renderizarTabela()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="todas">Todas as Etapas</option>
                    </select>
                    <select id="filtro-status" onchange="renderizarTabela()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="todos">Todos os Status</option>
                        <option value="Em andamento">Em andamento</option>
                        <option value="Conclu√≠do">Conclu√≠do</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Atrasado">Atrasado</option>
                    </select>
                    <select id="filtro-cliente" onchange="renderizarTabela()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="todos">Todos os Clientes</option>
                    </select>
                    <!-- CORRE√á√ÉO 1: Filtro por respons√°vel CORRIGIDO -->
                    <select id="filtro-responsavel" onchange="renderizarTabela()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="todos">Todos os Respons√°veis</option>
                    </select>
                    <input type="text" id="busca-projeto" placeholder="Buscar projeto..." onkeyup="renderizarTabela()" 
                        class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                </div>
                <div class="flex gap-2">
                    <button onclick="mostrarImportacaoCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                        üìÅ Importar CSV
                    </button>
                    <button onclick="mostrarConfigAPI()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm">
                        ‚öôÔ∏è API Config
                    </button>
                    <button onclick="exportToExcel()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 text-sm">
                        üì• Excel
                    </button>
                    <button onclick="backupDados()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 text-sm">
                        üíæ Backup
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabela de Projetos -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="px-4 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">Projetos (<span id="total-filtrados">0</span>)</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Projeto</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Etapa Atual</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Progresso</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Respons√°vel</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prazo</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Laudo</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-projetos" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal de Importa√ß√£o CSV -->
        <div id="modal-csv" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900">üìÅ Importar CSV do NewTech v25</h2>
                    <button onclick="fecharModal('modal-csv')" class="text-gray-500 hover:text-gray-700 text-xl">‚ùå</button>
                </div>
                
                <div class="space-y-4">
                    <!-- Upload √°rea -->
                    <div class="csv-upload" id="csv-upload-area" onclick="document.getElementById('csv-file-input').click()">
                        <div class="text-center">
                            <div class="text-4xl mb-2">üìÑ</div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">Selecione o arquivo CSV</h3>
                            <p class="text-sm text-gray-500 mb-4">Arraste e solte o arquivo CSV do NewTech v25 ou clique para selecionar</p>
                            <input type="file" id="csv-file-input" accept=".csv" style="display: none;" onchange="processarCSV(this.files[0])">
                            <button type="button" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
                                üìÅ Escolher Arquivo
                            </button>
                        </div>
                    </div>

                    <!-- Preview da importa√ß√£o -->
                    <div id="csv-preview" style="display: none;">
                        <h3 class="font-semibold text-gray-800 mb-2">üëÅÔ∏è Pr√©via da Importa√ß√£o</h3>
                        <div id="csv-preview-content" class="bg-gray-50 p-3 rounded border max-h-48 overflow-y-auto">
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button onclick="confirmarImportacaoCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                ‚úÖ Confirmar Importa√ß√£o
                            </button>
                            <button onclick="cancelarImportacaoCSV()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 text-sm">
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </div>

                    <!-- Instru√ß√µes -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-blue-800 mb-2">üìã Formato Esperado (NewTech v25)</h3>
                        <p class="text-sm text-blue-600 mb-2">O arquivo CSV deve ter as colunas:</p>
                        <ul class="text-xs text-blue-600 list-disc list-inside space-y-1">
                            <li><strong>Tarefa/T√≠tulo:</strong> Nome do projeto/tarefa</li>
                            <li><strong>Responsavel:</strong> Nome do respons√°vel (ser√° limpo automaticamente)</li>
                            <li><strong>Prazo Final:</strong> Data formato DD/MM/AAAA ou DD/MM/AAAA HH:MM</li>
                            <li><strong>Prioridade:</strong> alta, media, baixa, urgente (opcional)</li>
                            <li><strong>Descricao:</strong> Detalhes do projeto (opcional)</li>
                            <li><strong>Status:</strong> Pendente, Em andamento, Conclu√≠do (opcional)</li>
                        </ul>
                        <div class="mt-2 p-2 bg-white rounded text-xs">
                            <strong>Respons√°veis v√°lidos:</strong> Junior, Rodolfo, Eduardo Duarte, Cleiton Hardt, Thiago, Sidmar Vasconcelos, Fabiano Ramos, F√°bio Custodio, Vinicius Girotto, Jessica, Alexandre, Ulisses Peixoto
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURA√á√ÉO E DADOS GLOBAIS CORRIGIDOS ====================
        
        // CORRE√á√ÉO 3: Configura√ß√£o da API com sync de 10 minutos
        let configAPI = {
            url: 'http://localhost:8080/api',
            token: 'newtech-token-2025',
            syncAuto: false,
            syncInterval: 10, // CORRIGIDO: 5 ‚Üí 10 minutos
            ultimaSync: null
        };

        // Dados globais com estrutura melhorada
        let etapasProcesso = [
            { id: 1, nome: "Pedido Fechado", categoria: "inicial" },
            { id: 2, nome: "Projeto Mec√¢nico e El√©trico", categoria: "projeto" },
            { id: 3, nome: "Aprova√ß√£o do Cliente", categoria: "aprovacao" },
            { id: 4, nome: "Elaborar Lista de Materiais", categoria: "planejamento" },
            { id: 5, nome: "Or√ßar Materiais", categoria: "planejamento" },
            { id: 6, nome: "Aguardar Entrega dos Materiais", categoria: "suprimentos" },
            { id: 7, nome: "Montagem da M√°quina/Equipamento", categoria: "producao" },
            { id: 8, nome: "Montagem do Quadro El√©trico", categoria: "producao" },
            { id: 9, nome: "Teste El√©trico", categoria: "teste" },
            { id: 10, nome: "Teste Mec√¢nico", categoria: "teste" },
            { id: 11, nome: "Pintura/Zincagem (se aplicar)", categoria: "acabamento" },
            { id: 12, nome: "Montagem Final", categoria: "producao" },
            { id: 13, nome: "Teste Final", categoria: "teste" },
            { id: 14, nome: "Embalagem", categoria: "expedicao" },
            { id: 15, nome: "Envio de Documenta√ß√£o", categoria: "documentacao" },
            { id: 16, nome: "Envio de Laudo (quando aplic√°vel)", categoria: "documentacao" },
            { id: 17, nome: "Expedi√ß√£o", categoria: "expedicao" },
            { id: 18, nome: "Faturamento", categoria: "finalizacao" }
        ];

        let projetos = [
            { 
                id: 1, 
                nome: "FC75", 
                cliente: "Cliente A", 
                etapaAtual: 3, 
                status: "Em andamento", 
                responsavel: "RODOLFO, ULISSES", 
                temLaudo: true,
                prazoFinal: "2025-08-15",
                dataCriacao: "2025-07-01",
                observacoes: ""
            },
            { 
                id: 2, 
                nome: "PROJ_23", 
                cliente: "Cliente B", 
                etapaAtual: 8, 
                status: "Em andamento", 
                responsavel: "FABIANO, ALEXANDRE", 
                temLaudo: false,
                prazoFinal: "2025-08-30",
                dataCriacao: "2025-07-05",
                observacoes: ""
            },
            { 
                id: 3, 
                nome: "PROJ_22", 
                cliente: "Cliente C", 
                etapaAtual: 18, 
                status: "Conclu√≠do", 
                responsavel: "SIDMAR, F√ÅBIO", 
                temLaudo: true,
                prazoFinal: "2025-07-15",
                dataCriacao: "2025-06-20",
                observacoes: ""
            }
        ];

        let clientes = [
            { id: 1, nome: "Cliente A", contato: "contato@clientea.com" },
            { id: 2, nome: "Cliente B", contato: "contato@clienteb.com" },
            { id: 3, nome: "Cliente C", contato: "contato@clientec.com" }
        ];

        let funcionarios = [
            { id: 1, nome: "RODOLFO" },
            { id: 2, nome: "ULISSES" },
            { id: 3, nome: "FABIANO" },
            { id: 4, nome: "ALEXANDRE" },
            { id: 5, nome: "SIDMAR" },
            { id: 6, nome: "F√ÅBIO" },
            { id: 7, nome: "EDUARDO" },
            { id: 8, nome: "VINICIUS" },
            { id: 9, nome: "CLEITON" }
        ];

        let proximoId = {
            projeto: 4,
            cliente: 4,
            funcionario: 10,
            etapa: 19
        };

        let intervalosSync = [];
        let csvDataPreview = []; // Para armazenar dados do CSV em preview

        // ==================== FUN√á√ïES DE IMPORTA√á√ÉO CSV ====================

        function mostrarImportacaoCSV() {
            document.getElementById('modal-csv').classList.add('ativo');
            // Reset do estado
            document.getElementById('csv-preview').style.display = 'none';
            document.getElementById('csv-file-input').value = '';
            csvDataPreview = [];
        }

        function processarCSV(file) {
            if (!file) return;
            
            console.log('üìÅ INICIANDO PROCESSAMENTO CSV');
            console.log('Arquivo:', file.name, 'Tamanho:', file.size, 'bytes');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    console.log('üìÑ Conte√∫do CSV carregado, primeiros 200 chars:', csvContent.substring(0, 200));
                    
                    // Limpar e dividir linhas
                    const lines = csvContent.split(/\r?\n|\r/).filter(line => line.trim());
                    console.log('üìä Total de linhas:', lines.length);
                    
                    if (lines.length < 2) {
                        mostrarNotificacao('‚ùå CSV precisa ter pelo menos 2 linhas (cabe√ßalho + dados)', 'error');
                        return;
                    }

                    // Detectar separador
                    const firstLine = lines[0];
                    let separator = ',';
                    const semicolonCount = (firstLine.match(/;/g) || []).length;
                    const commaCount = (firstLine.match(/,/g) || []).length;
                    const tabCount = (firstLine.match(/\t/g) || []).length;
                    
                    if (semicolonCount > commaCount && semicolonCount > tabCount) {
                        separator = ';';
                    } else if (tabCount > commaCount && tabCount > semicolonCount) {
                        separator = '\t';
                    }

                    console.log(`üîß Separador detectado: "${separator === '\t' ? 'TAB' : separator}"`);

                    // Processar cabe√ßalhos
                    const headers = lines[0].split(separator)
                        .map(h => h.trim().replace(/"/g, '').replace(/\r/g, '').replace(/\n/g, '').replace(/\uFEFF/g, ''));
                        
                    console.log('üìã CABE√áALHOS:', headers);

                    // Identificar colunas automaticamente
                    const columnMapping = identificarColunas(headers);
                    console.log('üéØ MAPEAMENTO AUTOM√ÅTICO:', columnMapping);

                    if (columnMapping.title === -1) {
                        mostrarNotificacao('‚ùå N√£o foi poss√≠vel identificar a coluna de t√≠tulo/tarefa', 'error');
                        return;
                    }

                    // Processar dados
                    csvDataPreview = [];
                    let sucessos = 0;
                    let erros = 0;

                    for (let i = 1; i < lines.length; i++) {
                        try {
                            const cols = lines[i].split(separator).map(col => col.trim().replace(/"/g, ''));
                            
                            const titulo = cols[columnMapping.title] || '';
                            const responsavelOriginal = cols[columnMapping.assignee] || '';
                            const prazo = cols[columnMapping.deadline] || '';
                            const prioridade = cols[columnMapping.priority] || 'media';
                            const descricao = cols[columnMapping.description] || '';
                            const status = cols[columnMapping.status] || 'Em andamento';

                            if (titulo.trim()) {
                                const responsavelLimpo = limparResponsavel(responsavelOriginal);
                                const clienteExtraido = extrairCliente(titulo);
                                
                                const item = {
                                    original: {
                                        linha: i,
                                        titulo: titulo,
                                        responsavelOriginal: responsavelOriginal,
                                        prazo: prazo,
                                        prioridade: prioridade,
                                        descricao: descricao,
                                        status: status
                                    },
                                    processado: {
                                        nome: titulo,
                                        responsavel: responsavelLimpo,
                                        cliente: clienteExtraido,
                                        prazoFinal: converterData(prazo),
                                        etapaAtual: determinarEtapa(status),
                                        status: normalizarStatus(status),
                                        temLaudo: titulo.toLowerCase().includes('laudo'),
                                        observacoes: descricao,
                                        dataCriacao: new Date().toISOString().split('T')[0]
                                    },
                                    valido: true,
                                    alertas: []
                                };

                                // Valida√ß√µes
                                if (!responsavelLimpo || responsavelLimpo === 'Junior') {
                                    item.alertas.push(`Respons√°vel "${responsavelOriginal}" convertido para "Junior"`);
                                }

                                if (!item.processado.prazoFinal) {
                                    item.alertas.push('Prazo n√£o informado, usando padr√£o (7 dias)');
                                }

                                csvDataPreview.push(item);
                                sucessos++;
                            } else {
                                erros++;
                                console.log(`‚ùå Linha ${i} ignorada: t√≠tulo vazio`);
                            }
                        } catch (lineError) {
                            console.error(`‚ùå Erro na linha ${i}:`, lineError);
                            erros++;
                        }
                    }

                    console.log(`‚úÖ Processamento conclu√≠do: ${sucessos} sucessos, ${erros} erros`);
                    
                    if (csvDataPreview.length > 0) {
                        mostrarPreviewCSV();
                    } else {
                        mostrarNotificacao('‚ùå Nenhum dado v√°lido encontrado no CSV', 'error');
                    }

                } catch (error) {
                    console.error('‚ùå Erro geral no processamento:', error);
                    mostrarNotificacao('‚ùå Erro ao processar CSV: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        function identificarColunas(headers) {
            const mapping = { title: -1, assignee: -1, deadline: -1, priority: -1, description: -1, status: -1 };
            
            headers.forEach((header, index) => {
                const h = header.toLowerCase();
                
                // T√≠tulo/Tarefa
                if (h.includes('tarefa') || h.includes('titulo') || h.includes('nome') || h.includes('projeto')) {
                    mapping.title = index;
                }
                
                // Respons√°vel
                if (h.includes('responsavel') || h.includes('respons√°vel') || h.includes('atribuido') || h.includes('assignee')) {
                    mapping.assignee = index;
                }
                
                // Prazo
                if (h.includes('prazo') || h.includes('deadline') || h.includes('data') || h.includes('vencimento')) {
                    mapping.deadline = index;
                }
                
                // Prioridade
                if (h.includes('prioridade') || h.includes('priority') || h.includes('urgencia')) {
                    mapping.priority = index;
                }
                
                // Descri√ß√£o
                if (h.includes('descricao') || h.includes('descri√ß√£o') || h.includes('detalhes') || h.includes('observ')) {
                    mapping.description = index;
                }
                
                // Status
                if (h.includes('status') || h.includes('estado') || h.includes('situacao')) {
                    mapping.status = index;
                }
            });
            
            return mapping;
        }

        // CORRE√á√ÉO 1: Fun√ß√£o melhorada para limpar respons√°veis
        function limparResponsavel(responsavel) {
            if (!responsavel || responsavel.trim() === '') return 'Junior';
            
            console.log(`üîç LIMPANDO RESPONS√ÅVEL: "${responsavel}"`);
            
            // Lista de respons√°veis v√°lidos
            const responsaveisValidos = [
                'Junior', 'Rodolfo', 'Eduardo Duarte', 'Cleiton Hardt', 
                'Thiago', 'Sidmar Vasconcelos', 'Fabiano Ramos', 
                'F√°bio Custodio', 'Vinicius Girotto', 'Jessica', 
                'Alexandre', 'Ulisses Peixoto'
            ];

            // Mapeamento de nomes alternativos MELHORADO
            const mapeamento = {
                'junior': 'Junior',
                'j√∫nior': 'Junior',
                'carandina': 'Junior',
                'junior carandina': 'Junior',
                'rodolfo': 'Rodolfo',
                'rodolfo lucas': 'Rodolfo',
                'eduardo': 'Eduardo Duarte',
                'eduardo duarte': 'Eduardo Duarte',
                'cleiton': 'Cleiton Hardt',
                'cleiton hardt': 'Cleiton Hardt',
                'thiago': 'Thiago',
                'sidmar': 'Sidmar Vasconcelos',
                'sidmar vasconcelos': 'Sidmar Vasconcelos',
                'fabiano': 'Fabiano Ramos',
                'fabiano ramos': 'Fabiano Ramos',
                'fabio': 'F√°bio Custodio',
                'f√°bio': 'F√°bio Custodio',
                'fabio custodio': 'F√°bio Custodio',
                'f√°bio custodio': 'F√°bio Custodio',
                'vinicius': 'Vinicius Girotto',
                'vinicius girotto': 'Vinicius Girotto',
                'jessica': 'Jessica',
                'j√©ssica': 'Jessica',
                'alexandre': 'Alexandre',
                'ulisses': 'Ulisses Peixoto',
                'ulisses peixoto': 'Ulisses Peixoto'
            };

            // Limpar o nome primeiro
            let nomeLimpo = responsavel.toString()
                .split(';')[0]
                .split(',')[0] // NOVO: dividir por v√≠rgula tamb√©m
                .split('-')[0]
                .split('PO')[0]
                .split('Pedido')[0]
                .replace(/\d+/g, '')
                .replace(/[^\w\s√Ä-√ø]/g, ' ')
                .trim()
                .toLowerCase();

            console.log(`   Nome limpo: "${nomeLimpo}"`);

            // Procurar match exato primeiro
            if (mapeamento[nomeLimpo]) {
                console.log(`   ‚úÖ Match exato: ${mapeamento[nomeLimpo]}`);
                return mapeamento[nomeLimpo];
            }

            // Procurar por um nome v√°lido dentro do texto
            for (const nome of responsaveisValidos) {
                if (nomeLimpo.includes(nome.toLowerCase())) {
                    console.log(`   ‚úÖ Match parcial: ${nome}`);
                    return nome;
                }
            }

            // Se n√£o encontrou, retornar o primeiro nome ou Junior
            const primeiroNome = nomeLimpo.split(' ')[0];
            const resultado = primeiroNome || 'Junior';
            console.log(`   ‚ö†Ô∏è Usando padr√£o: ${resultado}`);
            return resultado;
        }

        function extrairCliente(titulo) {
            // Tentar extrair cliente do t√≠tulo (palavras em mai√∫scula no in√≠cio)
            const match = titulo.match(/^([A-Z][A-Z\s&\-]+?)(?:\s*[-‚Äì‚Äî]|\s*\d)/);
            if (match) {
                const cliente = match[1].trim();
                if (cliente.length > 2 && cliente.length < 50) {
                    return cliente;
                }
            }
            
            // Clientes conhecidos
            const clientesConhecidos = ['UFI', 'ZF AUTOMOTIVE', 'KNORR', 'SIEMENS', 'BOSCH', 'VOLKSWAGEN', 'MERCEDES'];
            for (const cliente of clientesConhecidos) {
                if (titulo.toUpperCase().includes(cliente)) {
                    return cliente;
                }
            }
            
            return 'Cliente Geral';
        }

        function converterData(dataStr) {
            if (!dataStr || dataStr.trim() === '') {
                const futuro = new Date();
                futuro.setDate(futuro.getDate() + 7);
                return futuro.toISOString().split('T')[0];
            }

            // Formato brasileiro: DD/MM/YYYY HH:MM
            const match1 = dataStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2})/);
            if (match1) {
                const date = new Date(
                    parseInt(match1[3]), // ano
                    parseInt(match1[2]) - 1, // m√™s (0-based)
                    parseInt(match1[1]), // dia
                    parseInt(match1[4]), // hora
                    parseInt(match1[5])  // minuto
                );
                return date.toISOString().split('T')[0];
            }

            // Formato brasileiro apenas data: DD/MM/YYYY
            const match2 = dataStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if (match2) {
                const date = new Date(
                    parseInt(match2[3]), // ano
                    parseInt(match2[2]) - 1, // m√™s (0-based)
                    parseInt(match2[1])  // dia
                );
                return date.toISOString().split('T')[0];
            }

            // Tentar parsing direto
            const date = new Date(dataStr);
            if (!isNaN(date.getTime())) {
                return date.toISOString().split('T')[0];
            }

            // Se n√£o conseguir converter, usar 7 dias no futuro
            const futuro = new Date();
            futuro.setDate(futuro.getDate() + 7);
            return futuro.toISOString().split('T')[0];
        }

        function determinarEtapa(status) {
            if (!status) return 1;
            const s = status.toLowerCase();
            if (s.includes('conclu') || s.includes('finaliz') || s.includes('entregue')) return 18;
            if (s.includes('teste') || s.includes('valida√ß√£o')) return 13;
            if (s.includes('montagem') || s.includes('produ√ß√£o')) return 7;
            if (s.includes('material') || s.includes('compra')) return 6;
            if (s.includes('projeto') || s.includes('desenho')) return 2;
            return 3; // Padr√£o: Aprova√ß√£o do Cliente
        }

        function normalizarStatus(status) {
            if (!status) return 'Em andamento';
            const s = status.toLowerCase();
            if (s.includes('conclu') || s.includes('finaliz') || s.includes('entregue') || s.includes('done') || s.includes('complete')) return 'Conclu√≠do';
            if (s.includes('pendente') || s.includes('parado') || s.includes('aguard') || s.includes('hold') || s.includes('waiting')) return 'Pendente';
            if (s.includes('aberto') || s.includes('ativo') || s.includes('progress') || s.includes('doing') || s.includes('working')) return 'Em andamento';
            if (s.includes('reaberto') || s.includes('reativado') || s.includes('retomado') || s.includes('reiniciado')) return 'Em andamento';
            return 'Em andamento';
        }

        function mostrarPreviewCSV() {
            const previewDiv = document.getElementById('csv-preview');
            const contentDiv = document.getElementById('csv-preview-content');
            
            let html = `<div class="text-sm font-medium mb-2">üìä ${csvDataPreview.length} itens processados:</div>`;
            
            csvDataPreview.slice(0, 10).forEach((item, index) => {
                const alertClass = item.alertas.length > 0 ? 'csv-error' : 'csv-success';
                html += `
                    <div class="csv-preview-item ${alertClass}">
                        <div class="font-medium">${item.processado.nome}</div>
                        <div class="text-xs text-gray-600">
                            üë§ ${item.original.responsavelOriginal} ‚Üí ${item.processado.responsavel} | 
                            üìÖ ${item.original.prazo} ‚Üí ${item.processado.prazoFinal} |
                            üè¢ ${item.processado.cliente}
                        </div>
                        ${item.alertas.length > 0 ? `<div class="text-xs text-red-600 mt-1">‚ö†Ô∏è ${item.alertas.join(', ')}</div>` : ''}
                    </div>
                `;
            });
            
            if (csvDataPreview.length > 10) {
                html += `<div class="text-xs text-gray-500 text-center mt-2">... e mais ${csvDataPreview.length - 10} itens</div>`;
            }
            
            contentDiv.innerHTML = html;
            previewDiv.style.display = 'block';
        }

        function confirmarImportacaoCSV() {
            if (csvDataPreview.length === 0) {
                mostrarNotificacao('‚ùå Nenhum dado para importar', 'error');
                return;
            }
            
            let importados = 0;
            let clientesNovos = 0;
            let responsaveisNovos = 0;
            
            csvDataPreview.forEach(item => {
                const projeto = {
                    id: proximoId.projeto++,
                    ...item.processado
                };
                
                projetos.push(projeto);
                importados++;
                
                // Adicionar cliente se n√£o existir
                const clienteExiste = clientes.find(c => c.nome === item.processado.cliente);
                if (!clienteExiste) {
                    clientes.push({
                        id: proximoId.cliente++,
                        nome: item.processado.cliente,
                        contato: ''
                    });
                    clientesNovos++;
                    console.log('üè¢ Cliente adicionado:', item.processado.cliente);
                }

                // CORRE√á√ÉO 1: Adicionar respons√°veis √∫nicos √† lista
                const responsaveisNoProjeto = item.processado.responsavel.split(',').map(r => r.trim());
                responsaveisNoProjeto.forEach(resp => {
                    if (resp && !funcionarios.find(f => f.nome === resp)) {
                        funcionarios.push({
                            id: proximoId.funcionario++,
                            nome: resp
                        });
                        responsaveisNovos++;
                        console.log('üë§ Respons√°vel adicionado:', resp);
                    }
                });
            });
            
            salvarDados();
            atualizarInterface();
            fecharModal('modal-csv');
            
            let mensagem = `‚úÖ ${importados} projetos importados com sucesso!`;
            if (clientesNovos > 0) {
                mensagem += `\nüè¢ ${clientesNovos} novos clientes adicionados!`;
            }
            if (responsaveisNovos > 0) {
                mensagem += `\nüë§ ${responsaveisNovos} novos respons√°veis adicionados!`;
            }
            mostrarNotificacao(mensagem, 'success');
            
            // Sincronizar se configurado
            if (configAPI.syncAuto) {
                setTimeout(() => sincronizarComAPI(), 1000);
            }
        }

        function cancelarImportacaoCSV() {
            csvDataPreview = [];
            document.getElementById('csv-preview').style.display = 'none';
            document.getElementById('csv-file-input').value = '';
        }

        // ==================== PERSIST√äNCIA E SINCRONIZA√á√ÉO ====================

        function salvarDados() {
            const dados = {
                projetos,
                clientes,
                funcionarios,
                etapasProcesso,
                proximoId,
                configAPI,
                timestamp: new Date().toISOString()
            };
            
            try {
                const dadosString = JSON.stringify(dados);
                // Usando vari√°veis JavaScript em mem√≥ria ao inv√©s de localStorage
                window.dashboardData = dados;
                mostrarNotificacao('Dados salvos na mem√≥ria', 'success');
                return true;
            } catch (error) {
                mostrarNotificacao('Erro ao salvar dados: ' + error.message, 'error');
                return false;
            }
        }

        function carregarDados() {
            try {
                if (window.dashboardData) {
                    const dados = window.dashboardData;
                    
                    if (dados.projetos) projetos = dados.projetos;
                    if (dados.clientes) clientes = dados.clientes;
                    if (dados.funcionarios) funcionarios = dados.funcionarios;
                    if (dados.etapasProcesso) etapasProcesso = dados.etapasProcesso;
                    if (dados.proximoId) proximoId = dados.proximoId;
                    if (dados.configAPI) {
                        configAPI = { ...configAPI, ...dados.configAPI };
                        // CORRE√á√ÉO 3: Garantir que syncInterval seja 10
                        if (configAPI.syncInterval !== 10) {
                            configAPI.syncInterval = 10;
                            console.log('üîß CORRE√á√ÉO: Sync interval ajustado para 10 minutos');
                        }
                        carregarConfigAPI();
                    }
                    
                    mostrarNotificacao('Dados carregados da mem√≥ria', 'success');
                    return true;
                }
            } catch (error) {
                mostrarNotificacao('Erro ao carregar dados: ' + error.message, 'error');
            }
            return false;
        }

        // ==================== API E SINCRONIZA√á√ÉO CORRIGIDA ====================

        async function sincronizarComAPI() {
            if (!configAPI.url || !configAPI.token) {
                mostrarNotificacao('Configure a API antes de sincronizar', 'error');
                return false;
            }

            mostrarNotificacao('Sincronizando...', 'pending');
            
            try {
                // Simular chamada da API
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                configAPI.ultimaSync = new Date().toISOString();
                salvarDados();
                atualizarInterface();
                
                mostrarNotificacao('Sincroniza√ß√£o simulada conclu√≠da', 'success');
                document.getElementById('ultima-sync').textContent = new Date().toLocaleTimeString();
                document.getElementById('status-conexao').innerHTML = 'üü¢ Online';
                
                return true;
            } catch (error) {
                mostrarNotificacao('Erro na sincroniza√ß√£o: ' + error.message, 'error');
                document.getElementById('status-conexao').innerHTML = 'üî¥ Offline';
                console.error('‚ùå Erro na sincroniza√ß√£o:', error);
                return false;
            }
        }

        // CORRE√á√ÉO 3: Fun√ß√£o de configura√ß√£o de sync com 10 minutos
        function configurarSyncAuto() {
            const checkbox = document.getElementById('sync-auto');
            if (checkbox) {
                configAPI.syncAuto = checkbox.checked;
                
                intervalosSync.forEach(intervalo => clearInterval(intervalo));
                intervalosSync = [];
                
                if (configAPI.syncAuto) {
                    // CORRIGIDO: 5 min ‚Üí 10 min
                    const intervalo = setInterval(() => {
                        sincronizarComAPI();
                    }, configAPI.syncInterval * 60 * 1000); // 10 * 60 * 1000 = 600000ms = 10 min
                    intervalosSync.push(intervalo);
                    
                    mostrarNotificacao(`Sincroniza√ß√£o autom√°tica ativada (${configAPI.syncInterval} min)`, 'success');
                    document.getElementById('sync-interval').textContent = configAPI.syncInterval + ' min';
                } else {
                    mostrarNotificacao('Sincroniza√ß√£o autom√°tica desativada', 'success');
                }
                
                salvarDados();
            }
        }

        function sincronizarManual() {
            sincronizarComAPI();
        }

        // ==================== INTERFACE E NOTIFICA√á√ïES ====================

        function mostrarNotificacao(mensagem, tipo = 'success') {
            const indicator = document.getElementById('sync-indicator');
            indicator.textContent = mensagem;
            indicator.className = `sync-indicator sync-${tipo} fade-in`;
            indicator.style.display = 'block';
            
            setTimeout(() => {
                indicator.className = `sync-indicator sync-${tipo} fade-out`;
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 300);
            }, 3000);
        }

        function mostrarConfigAPI() {
            document.getElementById('config-api').style.display = 'block';
        }

        function salvarConfigAPI() {
            configAPI.url = document.getElementById('api-url').value;
            configAPI.token = document.getElementById('api-token').value;
            
            salvarDados();
            mostrarNotificacao('Configura√ß√£o da API salva', 'success');
            document.getElementById('config-api').style.display = 'none';
        }

        function carregarConfigAPI() {
            document.getElementById('api-url').value = configAPI.url || '';
            document.getElementById('api-token').value = configAPI.token || '';
            const syncAuto = document.getElementById('sync-auto');
            if (syncAuto) {
                syncAuto.checked = configAPI.syncAuto || false;
            }
            document.getElementById('sync-interval').textContent = configAPI.syncInterval + ' min';
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).classList.remove('ativo');
        }

        // ==================== FUN√á√ïES UTILIT√ÅRIAS MELHORADAS ====================

        function obterCorEtapa(etapa) {
            const etapaInfo = etapasProcesso.find(e => e.id === etapa);
            if (!etapaInfo) return 'bg-gray-100 text-gray-800';
            
            switch (etapaInfo.categoria) {
                case 'inicial': return 'bg-blue-100 text-blue-800';
                case 'projeto': return 'bg-purple-100 text-purple-800';
                case 'aprovacao': return 'bg-yellow-100 text-yellow-800';
                case 'planejamento': return 'bg-cyan-100 text-cyan-800';
                case 'suprimentos': return 'bg-orange-100 text-orange-800';
                case 'producao': return 'bg-green-100 text-green-800';
                case 'teste': return 'bg-red-100 text-red-800';
                case 'acabamento': return 'bg-pink-100 text-pink-800';
                case 'documentacao': return 'bg-indigo-100 text-indigo-800';
                case 'expedicao': return 'bg-teal-100 text-teal-800';
                case 'finalizacao': return 'bg-emerald-100 text-emerald-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function obterCorStatus(status) {
            switch (status) {
                case 'Conclu√≠do': return 'bg-green-100 text-green-800';
                case 'Em andamento': return 'bg-yellow-100 text-yellow-800';
                case 'Pendente': return 'bg-red-100 text-red-800';
                case 'Atrasado': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function calcularProgresso(etapa) {
            return Math.round((etapa / etapasProcesso.length) * 100);
        }

        // CORRE√á√ÉO 2: Fun√ß√£o corrigida para n√£o mostrar projetos conclu√≠dos como atrasados
        function calcularStatusPrazo(prazoFinal, statusAtual = null) {
            if (!prazoFinal) return '';
            
            // CORRE√á√ÉO 2: Se j√° est√° conclu√≠do, nunca mostrar como atrasado
            if (statusAtual === 'Conclu√≠do') {
                return 'Normal'; // N√£o mostrar como atrasado se j√° conclu√≠do
            }
            
            const hoje = new Date();
            const prazo = new Date(prazoFinal);
            const diffTime = prazo - hoje;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return 'Atrasado';
            if (diffDays <= 3) return 'Urgente';
            if (diffDays <= 7) return 'Pr√≥ximo';
            return 'Normal';
        }

        function formatarPrazo(prazoFinal) {
            if (!prazoFinal) return 'N√£o definido';
            
            const prazo = new Date(prazoFinal);
            const hoje = new Date();
            const diffTime = prazo - hoje;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            const dataFormatada = prazo.toLocaleDateString('pt-BR');
            
            if (diffDays < 0) {
                return `${dataFormatada} (${Math.abs(diffDays)} dias atraso)`;
            } else if (diffDays === 0) {
                return `${dataFormatada} (Hoje!)`;
            } else {
                return `${dataFormatada} (${diffDays} dias)`;
            }
        }

        // ==================== ESTAT√çSTICAS MELHORADAS ====================

        function atualizarEstatisticas() {
            const total = projetos.length;
            const concluidos = projetos.filter(p => p.status === 'Conclu√≠do').length;
            const andamento = projetos.filter(p => p.status === 'Em andamento').length;
            const etapaMedia = total > 0 ? projetos.reduce((acc, p) => acc + p.etapaAtual, 0) / total : 0;
            
            // NOVO: Contar pessoas ativas (que t√™m projetos em andamento)
            const responsaveisAtivos = new Set();
            projetos.filter(p => p.status !== 'Conclu√≠do').forEach(p => {
                const responsaveis = p.responsavel.split(',').map(r => r.trim());
                responsaveis.forEach(r => responsaveisAtivos.add(r));
            });
            
            const projetosComPrazo = projetos.filter(p => p.prazoFinal && p.status !== 'Conclu√≠do');
            let prazoMedio = 0;
            
            if (projetosComPrazo.length > 0) {
                const hoje = new Date();
                const totalDias = projetosComPrazo.reduce((acc, p) => {
                    const prazo = new Date(p.prazoFinal);
                    const diff = Math.ceil((prazo - hoje) / (1000 * 60 * 60 * 24));
                    return acc + Math.max(0, diff);
                }, 0);
                prazoMedio = Math.round(totalDias / projetosComPrazo.length);
            }

            document.getElementById('total-projetos').textContent = total;
            document.getElementById('projetos-concluidos').textContent = concluidos;
            document.getElementById('projetos-andamento').textContent = andamento;
            document.getElementById('etapa-media').textContent = etapaMedia.toFixed(1);
            document.getElementById('pessoas-ativas').textContent = responsaveisAtivos.size;
            document.getElementById('prazo-medio').textContent = prazoMedio + ' dias';
        }

        // ==================== RENDERIZA√á√ÉO DA TABELA MELHORADA ====================

        function renderizarTabela() {
            const projetosFiltrados = filtrarProjetos();
            document.getElementById('total-filtrados').textContent = projetosFiltrados.length;

            const tbody = document.getElementById('tabela-projetos');
            tbody.innerHTML = '';

            projetosFiltrados.forEach(projeto => {
                const etapa = etapasProcesso.find(e => e.id === projeto.etapaAtual);
                const progresso = calcularProgresso(projeto.etapaAtual);
                // CORRE√á√ÉO 2: Passar o status atual para n√£o mostrar conclu√≠dos como atrasados
                const statusPrazo = calcularStatusPrazo(projeto.prazoFinal, projeto.status);
                const prazoFormatado = formatarPrazo(projeto.prazoFinal);

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // CORRE√á√ÉO 2: N√£o destacar como atrasado se j√° est√° conclu√≠do
                if (projeto.status !== 'Conclu√≠do') {
                    if (statusPrazo === 'Atrasado') {
                        row.className += ' bg-red-50';
                    } else if (statusPrazo === 'Urgente') {
                        row.className += ' bg-yellow-50';
                    }
                }

                row.innerHTML = `
                    <td class="px-3 py-4">
                        <div class="text-xs font-medium text-gray-900">${projeto.nome}</div>
                        <div class="text-xs text-gray-500">#${projeto.id}</div>
                    </td>
                    <td class="px-3 py-4">
                        <div class="text-xs text-gray-900">${projeto.cliente}</div>
                    </td>
                    <td class="px-3 py-4">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${obterCorEtapa(projeto.etapaAtual)}">
                            ${projeto.etapaAtual}. ${etapa ? etapa.nome.substring(0, 20) + '...' : 'Indefinida'}
                        </span>
                    </td>
                    <td class="px-3 py-4">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${progresso}%"></div>
                        </div>
                        <span class="text-xs text-gray-500">${progresso}%</span>
                    </td>
                    <td class="px-3 py-4">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${obterCorStatus(projeto.status === 'Conclu√≠do' ? 'Conclu√≠do' : (statusPrazo === 'Atrasado' ? 'Atrasado' : projeto.status))}">
                            ${projeto.status === 'Conclu√≠do' ? '‚úÖ Conclu√≠do' : (statusPrazo === 'Atrasado' && projeto.status !== 'Conclu√≠do' ? 'Atrasado' : projeto.status)}
                        </span>
                    </td>
                    <td class="px-3 py-4">
                        <div class="text-xs text-gray-900">${projeto.responsavel}</div>
                    </td>
                    <td class="px-3 py-4">
                        <div class="text-xs ${projeto.status === 'Conclu√≠do' ? 'text-green-600 font-bold' : (statusPrazo === 'Atrasado' ? 'text-red-600 font-bold' : statusPrazo === 'Urgente' ? 'text-yellow-600 font-bold' : 'text-gray-900')}">
                            ${projeto.status === 'Conclu√≠do' ? '‚úÖ ' + prazoFormatado : prazoFormatado}
                        </div>
                    </td>
                    <td class="px-3 py-4 text-center">
                        ${projeto.temLaudo ? '<span class="text-green-600">‚úÖ</span>' : '<span class="text-gray-400">‚ùå</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // CORRE√á√ÉO 1: Fun√ß√£o melhorada de filtros com filtro por respons√°vel
        function filtrarProjetos() {
            const filtroEtapa = document.getElementById('filtro-etapa').value;
            const filtroStatus = document.getElementById('filtro-status').value;
            const filtroCliente = document.getElementById('filtro-cliente').value;
            const filtroResponsavel = document.getElementById('filtro-responsavel').value;
            const buscaProjeto = document.getElementById('busca-projeto').value.toLowerCase();
            
            return projetos.filter(projeto => {
                // CORRE√á√ÉO 2: Status real considerando se est√° conclu√≠do
                const statusReal = projeto.status === 'Conclu√≠do' ? 'Conclu√≠do' : 
                    (calcularStatusPrazo(projeto.prazoFinal, projeto.status) === 'Atrasado' ? 'Atrasado' : projeto.status);
                
                const passaEtapa = filtroEtapa === 'todas' || projeto.etapaAtual.toString() === filtroEtapa;
                const passaStatus = filtroStatus === 'todos' || statusReal === filtroStatus;
                const passaCliente = filtroCliente === 'todos' || projeto.cliente === filtroCliente;
                
                // CORRE√á√ÉO 1: Filtro por respons√°vel corrigido
                const passaResponsavel = filtroResponsavel === 'todos' || 
                    projeto.responsavel.toLowerCase().includes(filtroResponsavel.toLowerCase());
                
                const passaBusca = !buscaProjeto || 
                    projeto.nome.toLowerCase().includes(buscaProjeto) ||
                    projeto.cliente.toLowerCase().includes(buscaProjeto) ||
                    projeto.responsavel.toLowerCase().includes(buscaProjeto);
                
                return passaEtapa && passaStatus && passaCliente && passaResponsavel && passaBusca;
            });
        }

        // ==================== BACKUP E RESTAURA√á√ÉO ====================

        function backupDados() {
            const backup = {
                projetos,
                clientes,
                funcionarios,
                etapasProcesso,
                proximoId,
                configAPI: { ...configAPI, token: '' },
                versao: '2.1-CORRIGIDO',
                timestamp: new Date().toISOString(),
                correcoes: [
                    'Filtro por respons√°vel corrigido',
                    'Projetos conclu√≠dos n√£o aparecem mais como atrasados',
                    'Sincroniza√ß√£o autom√°tica alterada para 10 minutos'
                ]
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `newtech_backup_corrigido_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarNotificacao('Backup CORRIGIDO criado com sucesso', 'success');
        }

        function exportToExcel() {
            const projetosFiltrados = filtrarProjetos();
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID,Nome,Cliente,Etapa,Status,Responsavel,Prazo,Tem_Laudo,Observacoes\n";
            
            projetosFiltrados.forEach(projeto => {
                const etapa = etapasProcesso.find(e => e.id === projeto.etapaAtual);
                // CORRE√á√ÉO 2: Status real considerando se est√° conclu√≠do
                const statusReal = projeto.status === 'Conclu√≠do' ? 'Conclu√≠do' : 
                    (calcularStatusPrazo(projeto.prazoFinal, projeto.status) === 'Atrasado' ? 'Atrasado' : projeto.status);
                const prazoFormatado = projeto.prazoFinal ? new Date(projeto.prazoFinal).toLocaleDateString('pt-BR') : 'N√£o definido';
                
                csvContent += `${projeto.id},"${projeto.nome}","${projeto.cliente}","${projeto.etapaAtual}. ${etapa ? etapa.nome : 'Indefinida'}","${statusReal}","${projeto.responsavel}","${prazoFormatado}",${projeto.temLaudo ? 'Sim' : 'N√£o'},"${projeto.observacoes || ''}"\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `projetos_newtech_corrigido_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ==================== INTERFACE PRINCIPAL MELHORADA ====================

        function atualizarInterface() {
            atualizarFiltroEtapas();
            atualizarFiltroClientes();
            atualizarFiltroResponsaveis(); // CORRE√á√ÉO 1: Novo filtro
            renderizarTabela();
            atualizarEstatisticas();
        }

        function atualizarFiltroEtapas() {
            const select = document.getElementById('filtro-etapa');
            select.innerHTML = '<option value="todas">Todas as Etapas</option>';
            
            etapasProcesso.forEach(etapa => {
                const option = document.createElement('option');
                option.value = etapa.id;
                option.textContent = `${etapa.id}. ${etapa.nome}`;
                select.appendChild(option);
            });
        }

        function atualizarFiltroClientes() {
            const select = document.getElementById('filtro-cliente');
            select.innerHTML = '<option value="todos">Todos os Clientes</option>';
            
            const clientesUnicos = [...new Set(projetos.map(p => p.cliente))].sort();
            clientesUnicos.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente;
                option.textContent = cliente;
                select.appendChild(option);
            });
        }

        // CORRE√á√ÉO 1: Nova fun√ß√£o para filtro por respons√°veis
        function atualizarFiltroResponsaveis() {
            const select = document.getElementById('filtro-responsavel');
            if (!select) return;
            
            select.innerHTML = '<option value="todos">Todos os Respons√°veis</option>';
            
            // Extrair todos os respons√°veis √∫nicos dos projetos
            const responsaveisUnicos = new Set();
            projetos.forEach(projeto => {
                const responsaveis = projeto.responsavel.split(',').map(r => r.trim());
                responsaveis.forEach(resp => {
                    if (resp) responsaveisUnicos.add(resp);
                });
            });
            
            // Ordenar e adicionar as op√ß√µes
            [...responsaveisUnicos].sort().forEach(responsavel => {
                const option = document.createElement('option');
                option.value = responsavel;
                option.textContent = responsavel;
                select.appendChild(option);
            });
        }

        // ==================== INICIALIZA√á√ÉO ====================

        function inicializar() {
            console.log('üöÄ Inicializando Dashboard New Tech - CORRIGIDO');
            
            // Carregar dados salvos
            carregarDados();
            
            // Atualizar interface
            atualizarInterface();
            carregarConfigAPI();
            
            // Configurar drag and drop para CSV
            const uploadArea = document.getElementById('csv-upload-area');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('drag-over');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('drag-over');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        processarCSV(files[0]);
                    }
                });
            }
            
            console.log('‚úÖ Dashboard inicializado com todas as corre√ß√µes aplicadas!');
            mostrarNotificacao('Dashboard carregado com corre√ß√µes aplicadas!', 'success');
        }

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', inicializar);

    </script>
</body>
</html>
